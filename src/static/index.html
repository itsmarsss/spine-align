<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Image Processing</title>
  </head>
  <body>
    <h2>Upload an Image</h2>
    <form action="/upload" method="post" enctype="multipart/form-data">
      <input type="file" name="image" accept="image/*" />
      <input type="submit" value="Upload" />
    </form>

    <h2>Stream Webcam</h2>
    <button onclick="startWebcam()">Start Webcam</button>
    <br /><br />
    <video id="webcam" autoplay></video>
    <div id="results-container">
      <div id="depth-map-container"></div>
      <div id="face-detection-container"></div>
    </div>

    <script>
      const video = document.getElementById("webcam");

      const startWebcam = async () => {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
        });
        video.srcObject = stream;

        const ws = new WebSocket("ws://" + window.location.host + "/ws");

        ws.onopen = () => {
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");

          const sendFrame = () => {
            // Set the canvas size to match the video size
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataURL = canvas.toDataURL("image/jpeg");
            ws.send(dataURL);
            requestAnimationFrame(sendFrame);
          };

          requestAnimationFrame(sendFrame);
        };

        ws.onmessage = (event) => {
          const [depthImage, faceImage] = event.data.split("|");

          const depthImg = new Image();
          depthImg.src = depthImage;
          const depthContainer = document.getElementById("depth-map-container");
          depthContainer.innerHTML = "";
          depthContainer.appendChild(depthImg);

          const faceImg = new Image();
          faceImg.src = faceImage;
          const faceContainer = document.getElementById(
            "face-detection-container"
          );
          faceContainer.innerHTML = "";
          faceContainer.appendChild(faceImg);
        };
      };
    </script>
  </body>
</html>
